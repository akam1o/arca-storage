name: Python Tests

on:
  workflow_call:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      # Run only on Python 3.9 to reduce CI usage (EL9 baseline)
      matrix:
        python-version:
          - '3.9'
          # - '3.11'
          # - '3.12'

    steps:
      - uses: actions/checkout@v4
        with:
          # setuptools-scm derives versions from Git tags (e.g. v0.2.7).
          fetch-depth: 0

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          cache-dependency-path: 'arca_storage/requirements.txt'

      - name: Build sdist and wheel
        working-directory: ./arca_storage
        run: |
          python -m pip install --upgrade pip
          python -m pip install build
          python -m build --sdist --wheel
          echo "=== dist tree ==="
          ls -l dist
          echo "=== Listing sdist contents ==="
          tar -tzf dist/*.tar.gz | egrep "cli/(lib|__init__)" || echo "WARNING: cli or cli/lib not found in sdist!"
          echo "=== Listing wheel contents ==="
          python - <<'PY'
          import zipfile, glob
          whl = glob.glob('dist/*.whl')[0]
          with zipfile.ZipFile(whl) as z:
              members = [m for m in z.namelist() if 'cli/' in m]
              print('\\n'.join(members) or 'WARNING: cli not found in wheel!')
          PY

      - name: Install package and test deps
        working-directory: ./arca_storage
        run: |
          python -m pip install dist/*.tar.gz
          python -m pip install -r test-requirements.txt
          cd /tmp
          python - <<'PY'
          import sys, arca_storage
          from pathlib import Path
          print('Package location:', arca_storage.__file__)
          print('sys.path:', sys.path)
          import pkgutil
          print('packages:', [m.name for m in pkgutil.iter_modules(arca_storage.__path__)])
          from arca_storage import cli
          print('cli ok:', cli.__file__)
          from arca_storage.cli import lib
          print('cli.lib ok:', lib.__file__)
          # Show files on disk for debugging
          root = Path(lib.__file__).parent
          for p in sorted(root.iterdir()):
              print('lib content:', p)
          PY

      - name: Run tests with pytest
        run: |
          # Copy tests and config to a temp directory to avoid importing from source
          cp -r arca_storage/tests /tmp/tests
          cp arca_storage/pytest.ini /tmp/pytest.ini
          cd /tmp
          python -m pytest tests/unit tests/integration tests/openstack -v -m "not slow" --cov=arca_storage --cov-report=xml --cov-report=term
          # Copy coverage results back
          cp coverage.xml $GITHUB_WORKSPACE/arca_storage/

      - name: Upload coverage reports
        if: matrix.python-version == '3.9'
        uses: codecov/codecov-action@v4
        with:
          file: ./arca_storage/coverage.xml
          flags: unittests
          name: codecov-umbrella
        continue-on-error: true
