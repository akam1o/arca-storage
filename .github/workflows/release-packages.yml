name: Release Packages

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  debian:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build debs (Debian)
        run: |
          docker run --rm \
            -v "$GITHUB_WORKSPACE:/workspace" \
            -w /workspace \
            debian:bookworm \
            bash -lc '
              apt-get update &&
              apt-get install -y --no-install-recommends \
                ca-certificates build-essential dpkg-dev debhelper rsync \
                python3 python3-venv python3-pip &&
              rm -rf packaging/wheelhouse &&
              bash ./packaging/vendor-wheels.sh &&
              bash ./packaging/build-deb.sh
            '
      - name: Upload deb artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debian-debs
          path: packaging/out/deb/*

  ubuntu:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build debs (Ubuntu)
        run: |
          docker run --rm \
            -v "$GITHUB_WORKSPACE:/workspace" \
            -w /workspace \
            ubuntu:24.04 \
            bash -lc '
              apt-get update &&
              DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
                ca-certificates build-essential dpkg-dev debhelper rsync \
                python3 python3-venv python3-pip &&
              rm -rf packaging/wheelhouse &&
              bash ./packaging/vendor-wheels.sh &&
              bash ./packaging/build-deb.sh
            '
      - name: Upload deb artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-debs
          path: packaging/out/deb/*

  el9:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build rpms (EL9)
        run: |
          docker run --rm \
            -v "$GITHUB_WORKSPACE:/workspace" \
            -w /workspace \
            rockylinux:9 \
            bash -lc '
              dnf -y install git tar gzip rsync rpm-build python3 python3-pip &&
              rm -rf packaging/wheelhouse &&
              bash ./packaging/vendor-wheels.sh &&
              bash ./packaging/build-rpm.sh
            '
      - name: Upload rpm artifacts
        uses: actions/upload-artifact@v4
        with:
          name: el9-rpms
          path: packaging/out/rpm/*

  upload-to-release:
    runs-on: ubuntu-latest
    needs: [debian, ubuntu, el9]
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: "*-debs"
          path: dist
          merge-multiple: true
      - uses: actions/download-artifact@v4
        with:
          name: el9-rpms
          path: dist
      - name: Upload assets to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*.deb
            dist/*.changes
            dist/*.buildinfo
            dist/*.rpm
            dist/*.src.rpm
