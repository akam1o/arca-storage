---
- name: Install Pacemaker packages
  ansible.builtin.package:
    name: "{{ pacemaker_packages }}"
    state: present

- name: Ensure hacluster user password is set
  ansible.builtin.user:
    name: hacluster
    password: "{{ pacemaker_hacluster_password | password_hash('sha512', pacemaker_hacluster_password_salt) }}"
    update_password: on_create

- name: Enable and start pcsd
  ansible.builtin.service:
    name: pcsd
    state: started
    enabled: true

# Bootstrap cluster once from a designated node to avoid race conditions.
- name: Bootstrap Pacemaker cluster configuration
  block:
    - name: Authenticate nodes for pcs
      ansible.builtin.command: >-
        pcs host auth {{ pacemaker_nodes | map(attribute='name') | join(' ') }}
        -u hacluster -p {{ pacemaker_hacluster_password }}
      register: pcs_host_auth
      changed_when: pcs_host_auth.stdout is search("Authorized")

    - name: Check existing cluster authkey
      ansible.builtin.stat:
        path: /etc/corosync/authkey
      register: pacemaker_authkey

    - name: Create cluster configuration if missing
      ansible.builtin.command: >-
        pcs cluster setup --name {{ pacemaker_cluster_name }}
        {{ pacemaker_nodes | map(attribute='name') | join(' ') }}
      when: not pacemaker_authkey.stat.exists
      register: pcs_cluster_setup
      changed_when: pcs_cluster_setup.rc == 0
  rescue:
    - name: Report Pacemaker bootstrap failure
      ansible.builtin.fail:
        msg: "Pacemaker cluster bootstrap failed. Check pcs authentication, corosync configuration, and node connectivity."
  run_once: true
  delegate_to: "{{ pacemaker_cluster_bootstrap_node | default(pacemaker_nodes[0].name) }}"

- name: Ensure Corosync configuration
  ansible.builtin.template:
    src: corosync.conf.j2
    dest: /etc/corosync/corosync.conf
    owner: root
    group: root
    mode: "0644"
  notify: Restart Corosync

- name: Ensure custom RA vendor directory
  ansible.builtin.file:
    path: "/usr/lib/ocf/resource.d/{{ pacemaker_ra_vendor }}"
    state: directory
    owner: root
    group: root
    mode: "0755"
  when: pacemaker_custom_ra | length > 0 or pacemaker_install_netnsvlan_ra | default(true) | bool

- name: Install custom RA scripts
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: "/usr/lib/ocf/resource.d/{{ pacemaker_ra_vendor }}/{{ item | basename }}"
    owner: root
    group: root
    mode: "0755"
  loop: "{{ pacemaker_custom_ra }}"
  when: pacemaker_custom_ra | length > 0

- name: Install NetnsVlan resource agent
  ansible.builtin.copy:
    src: NetnsVlan
    dest: "/usr/lib/ocf/resource.d/{{ pacemaker_ra_vendor }}/NetnsVlan"
    owner: root
    group: root
    mode: "0755"
  when: pacemaker_install_netnsvlan_ra | default(true) | bool

- name: Enable and start Corosync
  ansible.builtin.service:
    name: corosync
    state: started
    enabled: true

- name: Enable and start Pacemaker
  ansible.builtin.service:
    name: pacemaker
    state: started
    enabled: true

# Ensure cluster services are running and properties are applied once.
- name: Start Pacemaker cluster services
  block:
    - name: Start cluster on all nodes
      ansible.builtin.command: pcs cluster start --all
      register: pcs_cluster_start
      changed_when: pcs_cluster_start.stdout is not search("already running")

    - name: Enable cluster to start on boot
      ansible.builtin.command: pcs cluster enable --all
      register: pcs_cluster_enable
      changed_when: pcs_cluster_enable.stdout is not search("already enabled")

    - name: Ensure STONITH property matches desired state
      ansible.builtin.command: pcs property show stonith-enabled
      register: pcs_stonith_property
      changed_when: false
      failed_when: false

    - name: Configure STONITH enabled property
      ansible.builtin.command: >-
        pcs property set stonith-enabled={{ pacemaker_enable_stonith | default(false) | bool | ternary('true','false') }}
      when: pcs_stonith_property.stdout is not search("stonith-enabled:\\s*{{ pacemaker_enable_stonith | default(false) | bool | ternary('true','false') }}")
      register: pcs_stonith_set
      changed_when: pcs_stonith_set.rc == 0
  rescue:
    - name: Report Pacemaker service startup failure
      ansible.builtin.fail:
        msg: "Pacemaker cluster start/enable failed. Verify corosync health and node connectivity."
  run_once: true
  delegate_to: "{{ pacemaker_cluster_bootstrap_node | default(pacemaker_nodes[0].name) }}"

- name: Include resource creation tasks
  ansible.builtin.include_tasks: resources.yml
  when: pacemaker_create_resources | default(true) | bool
