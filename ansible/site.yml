---
- name: Configure HA storage and services
  hosts: all
  become: true
  vars:
    ansible_python_interpreter: auto_silent
  pre_tasks:
    - name: Fail fast if default secrets are used (change for production)
      ansible.builtin.assert:
        that:
          - pacemaker_hacluster_password is defined
          - pacemaker_hacluster_password != "changeme"
          - drbd_shared_secret is defined
          - drbd_shared_secret != "changeme"
        fail_msg: >-
          Default secrets detected. Set pacemaker_hacluster_password and drbd_shared_secret to non-default values
          (use ansible-vault for production).
      when: not (test_mode | default(false) | bool)
  roles:
    - role: common
      tags: [common]
    - role: drbd
      tags: [drbd]
    - role: lvm
      tags: [lvm]
    - role: pacemaker
      tags: [pacemaker]
    - role: nfs-ganesha
      tags: [nfs_ganesha]
    - role: arca-cli
      tags: [arca_cli]
    - role: arca-runtime
      tags: [arca_runtime]
