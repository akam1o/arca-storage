# Packaging (rpm/deb)

This repository contains packaging scaffolding for:

- EL9 (RHEL 9 / AlmaLinux 9 / Rocky Linux 9): rpm
- Debian: deb
- Ubuntu: deb

## Strategy

To avoid relying on distribution Python dependencies (FastAPI/Uvicorn/Typer, etc.), packages install a dedicated virtualenv:

- venv path: `/opt/arca-storage/venv`
- wrappers:
  - `/usr/bin/arca` → venv `arca`
  - `/usr/bin/arca-storage-api` → venv `arca-storage-api`

System resources are installed to standard locations:

- configs (conffiles): `/etc/arca-storage/storage-bootstrap.conf`, `/etc/arca-storage/storage-runtime.conf`
- env file (generated by `arca bootstrap render-env`): `/etc/arca-storage/arca-storage.env`
- systemd units: `arca-storage-api.service`, `nfs-ganesha@.service`
- Pacemaker RA: `/usr/lib/ocf/resource.d/local/NetnsVlan`

## Wheelhouse requirement

The build uses an offline wheelhouse containing runtime dependencies.

Because Python versions differ by distro (EL9: 3.9, Ubuntu 24.04: 3.12, Debian bookworm: 3.11), generate the wheelhouse with the same Python version that will build the package (typically inside the target container/CI job).

Create wheelhouse:

```bash
bash ./packaging/vendor-wheels.sh
```

It produces:

- `packaging/wheelhouse/*.whl`

## Build (local)

### Debian/Ubuntu (deb)

```bash
bash ./packaging/build-deb.sh
```

### EL9 (rpm)

```bash
bash ./packaging/build-rpm.sh
```

## Notes

- These scripts are intended for CI/container builds. Host tooling requirements vary.
- If `packaging/wheelhouse/` is missing, the build scripts will run `./packaging/vendor-wheels.sh` automatically.
- Package versions are derived from the release tag (e.g. `v0.2.2`). Override with `ARCA_VERSION=0.2.2`.
- deb builds append a distro suffix (e.g. `0.2.2-1+debian.bookworm`, `0.2.2-1+ubuntu.noble`) so Debian/Ubuntu artifacts don't overwrite each other.
- Packages do not auto-enable services by default; enable explicitly:
  - `systemctl enable --now arca-storage-api`
